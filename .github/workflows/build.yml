name: Build

on:
    push:
        branches:
            - main

jobs:
    build:
        name: Build and analyze
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ matrix.python }}

            - name: Install uv
              uses: astral-sh/setup-uv@v7

            - name: Install dependences
              run: uv sync

            - name: Test
              run: uv run pytest --cov --cov-report xml

            - name: Get version with uv
              id: uv_version
              run: echo "version=$(uv version --short)" >> $GITHUB_OUTPUT

            - uses: SonarSource/sonarqube-scan-action@v6
              with:
                  args: >
                      -Dsonar.projectVersion="${{ steps.uv_version.outputs.version }}"
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
            # If you wish to fail your job when the Quality Gate is red, uncomment the
            # following lines. This would typically be used to fail a deployment.
            # - uses: SonarSource/sonarqube-quality-gate-action@v1
            #   timeout-minutes: 5
            #   env:
            #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
